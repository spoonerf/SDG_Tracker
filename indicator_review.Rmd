---
title: "SDG Indicator Review"
author: "Fiona Spooner"
date: "`r format(Sys.time(), '%d %B, %Y')`"
output: 
  prettydoc::html_pretty:
    theme: leonids
    highlight: github
    toc: true
geometry: margin=3cm
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(message = FALSE, warning = FALSE, dpi = 100, fig.align="center")
source("sdg_useful.R")
```

```{r Setup, echo = FALSE}
library(dplyr)
library(ggplot2)
library(janitor)
library(kableExtra)
library(knitr)
library(RColorBrewer)
library(readr)
library(readxl)
library(rnaturalearth)
library(rnaturalearthdata)
library(rnaturalearthhires)
library(sf)
library(tidyr)
```



```{r, echo = FALSE}
#SDG Tracker Gaps

world <- ne_countries(scale = "large", returnclass = "sf")

all_inds_fp <-
  list.files("Data",
             pattern = "*I_",
             recursive = TRUE,
             full.names = TRUE)

full_country_seq <- function(file_path) {
  dat <- clean_names(read_csv(file_path))
  goal <- file_path %>% gsub("Data/", "", .) %>% gsub("/T.*", "", .)
  target <-
    file_path %>% gsub(paste0("Data/", goal, "/"), "", .) %>% gsub("/I_.*", "", .)
  indicator <-
    file_path %>% gsub(paste0("Data/", goal, "/", target, "/"), "", .) %>% sub("_[^_]+$", "", .)
  
  year_out <- dat %>%
    group_by(entity, code) %>%
    summarise(
      latest_data_year = max(year),
      goal = goal,
      target = target,
      indicator = indicator,
      indicator_desc = colnames(.)[4]
    )
  
  return(year_out)
  
}

last_data_df <- lapply(all_inds_fp, full_country_seq)

year_df <- do.call("rbind", last_data_df)
```

```{r, echo = FALSE}
year_df$goal <- year_df$goal %>%
  gsub("Goal_", "", .)

year_df$target <- year_df$target %>%
  gsub("Target_", "", .) %>% gsub("_", ".", .)

year_df$indicator <- year_df$indicator %>%
  gsub("I_", "", .) %>% gsub("_", ".", .)
```


```{r, echo = FALSE}
#Removing countries which are in the sdg tracker data but do not have a geometry in the #world sf - need to try downloading the rnaturalearthhighres package.

year_df <- year_df[year_df$code %in% world$iso_a3 & !is.na(year_df$code),]

```



```{r Loading and Cleaning Indicator Data, echo = FALSE}
inds <- clean_names(read_xlsx("Data/IndicatorSummary.xlsx"))

inds$indicator <-  inds$official_indicator %>% 
  gsub(":.*","",.) %>% 
  gsub("Indicator ", "", .)
```




```{r}
kable(inds %>% 
  group_by(pillar) %>% 
  summarise(count = n(),no_track_count = sum(sdg_tracker_indicator_available == "No"),tier_3 = sum(indicator_tier == 3), prop_no_ind = round((no_track_count/count)*100,2), prop_t3 = round((tier_3/count)*100,2)) %>% 
  select(pillar, prop_no_ind, prop_t3) %>% 
      arrange(-prop_no_ind), col.names = c("Pillar",
                           "Missing Indicators (%)",
                           "Tier 3 Indicators (%)"))%>%
  kable_styling(bootstrap_options = c("striped", "hover"))
```

```{r, echo = FALSE}

track_inds <- inds %>%
  dplyr::select(
    pillar,
    sdg,
    target,
    indicator,
    indicator_tier,
    sdg_tracker_indicator_available,
    sdgt_earliest_date,
    sdgt_date_of_most_recent_data) %>%
  distinct()%>% 
  group_by(indicator) %>% 
  tidyr::fill(pillar, .direction = "updown") %>% 
  ungroup()



```  


```{r, echo = FALSE}
countries <- rep(unique(year_df$entity), each = length(track_inds$indicator))
codes <- rep(unique(year_df$code), each = length(track_inds$indicator))

c_inds <-
  data.frame(countries = I(countries),
             code = codes,
             indicator = I(track_inds$indicator))

all_inds <- merge(c_inds, track_inds, by = "indicator", all = TRUE)


glob_inds <-
  merge(
    year_df,
    all_inds,
    by.x = c("entity", "code","indicator"),
    by.y = c("countries", "code","indicator"),
    all = TRUE
  ) %>%
  select(pillar, indicator_tier, goal, target.x, indicator, entity, code,  latest_data_year,sdg_tracker_indicator_available) %>% 
  arrange(indicator) %>% 
  rename(target = target.x) %>% 
  distinct() %>%
  group_by(indicator) %>% 
  tidyr::fill(pillar, .direction = "updown") %>%
  tidyr::fill(target, .direction = "updown") %>%
  ungroup() 

glob_inds$goal <- gsub("\\..*", "",glob_inds$indicator)

```


Plot showing indicator availability across all of the SDGs and pillars

```{r, echo = FALSE}
ind_ord <- unique(glob_inds$indicator)

glob_inds <- glob_inds %>%
  mutate(got_indicator = ifelse(grepl("Yes", sdg_tracker_indicator_available), 1, 0))

glob_inds$indicator <- factor(glob_inds$indicator, levels = ind_ord)
```

Indicator availablility per SDG - based on SDG Tracker data

```{r, echo = FALSE}

sdg_plot <- glob_inds %>% 
  dplyr::select(goal,indicator, got_indicator) %>% 
  group_by(goal) %>% 
  distinct() %>% 
  mutate(sum_inds = sum(got_indicator), num_inds = n(), prop_inds = (sum_inds/num_inds)*100) %>% 
  select(goal, sum_inds, num_inds, prop_inds) %>% 
  distinct() %>% 
  ungroup() %>% 
  mutate(goal = factor(goal, levels = 1:17)) %>% 
  ggplot(., aes(x = goal, y = prop_inds, group = goal,fill = goal, colour = goal))+
  geom_bar(stat = "identity") +
  sdg_fill_scale + 
  sdg_col_scale + 
  theme_fiona()+
  theme(legend.position = "none") + 
  ylab("Proportion of Indicators Available (%)") + 
  xlab("Sustainable Development Goal") + 
  ggtitle("Indicators Available on SDG Tracker") + 
  ylim(0,100)

sdg_plot

```

Proportion of indicator tiers in each goal 
```{r, echo = FALSE}
tier_goal_plot <- glob_inds %>% 
  dplyr::select(goal,indicator_tier,indicator) %>% 
  group_by(goal) %>% 
  distinct() %>% 
  ungroup() %>% 
  arrange(indicator_tier) %>% 
  mutate(goal = factor(goal, levels = 1:17)) %>% 
  ggplot(., aes(x = goal,fill = indicator_tier))+
  geom_bar(position = "fill") +
  theme_fiona()+
  ylab("Indicator Tier Breakdown") + 
  xlab("Sustainable Development Goal") + 
  ggtitle("Indicator Tiers Across Goals") + 
  ylim(0,1)

tier_goal_plot

```


Indicator availablility per Pillar - based on SDG Tracker data


```{r, echo = FALSE}
pillar_plot <- glob_inds %>% 
  dplyr::select(pillar,indicator, got_indicator) %>% 
  group_by(pillar) %>% 
  distinct() %>% 
  mutate(sum_inds = sum(got_indicator), num_inds = n(), prop_inds = (sum_inds/num_inds)*100) %>% 
  select(pillar, sum_inds, num_inds, prop_inds) %>% 
  distinct() %>% 
  ungroup() %>% 
  mutate(pillar = factor(pillar, levels = c("Economy", "Society", "Biosphere"))) %>% 
  ggplot(., aes(x = pillar, y = prop_inds, group = pillar,fill = pillar, colour = pillar))+
  geom_bar(stat = "identity") +
  pillar_fill_scale + 
  pillar_col_scale + 
  theme_fiona()+
  theme(legend.position = "none") + 
  ylab("Proportion of Indicators Available (%)") + 
  xlab("Sustainable Development Pillar") + 
  ggtitle("Indicators Available on SDG Tracker") +
  ylim(0,100)

pillar_plot


```

```{r, echo = FALSE}
pillar_tier_plot <- glob_inds %>% 
  dplyr::select(pillar,indicator_tier,indicator) %>% 
  group_by(pillar) %>% 
  distinct() %>% 
  ungroup() %>% 
  mutate(pillar = factor(pillar, levels = c("Economy", "Society", "Biosphere"))) %>% 
  ggplot(., aes(x = pillar,fill = indicator_tier))+
  geom_bar(position = "fill") +
  theme_fiona()+
  ylab("Proportion of each Indicator Tier") + 
  xlab("Sustainable Development Pillar") + 
  ggtitle("Indicator Tiers Across SDG Pillars") 

pillar_tier_plot


```

```{r, echo = FALSE, eval = FALSE}

jit_tier_track <- ggplot(glob_inds, aes(x = got_indicator, y = indicator_tier))+
  geom_jitter()
  
  
  

```

Looking at the age of each of the indicators, at a goal level

```{r, echo = FALSE}

goal_ind_age <- glob_inds %>% 
  filter(!is.na(latest_data_year)) %>% 
  group_by(goal, latest_data_year) %>% 
  mutate(year_freq = n()) %>%
  ungroup() %>% 
  mutate(goal = factor(goal, levels = 17:1)) %>% 
  select(goal, latest_data_year, year_freq) %>% 
  arrange(goal,latest_data_year) %>% 
  distinct() %>% 
  ggplot(., aes(x = latest_data_year, y = goal, size = year_freq, fill = goal, col = goal))+
  geom_point(alpha = 0.5, shape=21)+ 
  sdg_fill_scale + 
  sdg_col_scale +
  theme_fiona() + 
  theme(legend.position = "none") + 
  ylab("Sustainable Development Goal") + 
  xlab("Year") + 
  ggtitle("Age of Most Recent Indicator Data - All Countries")


goal_ind_age
 
```


```{r, echo = FALSE}
world_df <- data.frame(world %>% 
  select(iso_a3, region_un, continent, pop_est, gdp_md_est) %>% 
  mutate(code = iso_a3, region_un = as.factor(region_un)) %>% 
  left_join(., glob_inds, by = "code"))


goal_ind_age_region <- world_df %>% 
  filter(!is.na(latest_data_year) & region_un != "Antarctica"& region_un != "Seven seas (open ocean)") %>% 
  group_by(region_un, goal, latest_data_year) %>% 
  mutate(year_freq = n()) %>%
  ungroup() %>% 
  mutate(goal = factor(goal, levels = 17:1)) %>% 
  select(region_un, goal, latest_data_year, year_freq) %>% 
 # arrange(goal,latest_data_year) %>% 
  distinct() %>% 
  ggplot(., aes(x = latest_data_year, y = goal, size = year_freq, fill = goal, col = goal), group = region_un)+
  geom_point(alpha = 0.5, shape=21)+ 
  sdg_fill_scale + 
  sdg_col_scale +
  theme_fiona() + 
  theme(legend.position = "none") + 
  ylab("Sustainable Development Goal") + 
  xlab("Year") + 
  ggtitle("Age of Most Recent Indicator Data - By Region")+
  facet_wrap( ~ region_un)

goal_ind_age_region 


```


##indicators with the oldest data

 and the date of the most recent data collection

Which countries have the oldest data
```{r, eval = FALSE, echo = FALSE}

ggplot(glob_inds, aes(x = indicator, y = latest_data_year, group = pillar, colour = pillar))+
  geom_point()+
  theme_bw()


glob_inds %>% 
  group_by(entity) %>% 
  summarise(average_data_year = mean(na.omit(latest_data_year))) %>% 
  arrange(average_data_year)
  



```


The range of most recent dates for each indicator
```{r, eval = FALSE, echo = FALSE}

date_ranges <- glob_inds %>% 
  group_by(indicator) %>% 
  summarise(earliest_country_data = min(na.omit(latest_data_year)), latest_country_data = max(na.omit(latest_data_year))) 

date_ranges$earliest_country_data[is.infinite(date_ranges$earliest_country_data)] <- NA

date_ranges$latest_country_data[is.infinite(date_ranges$latest_country_data)] <- NA

```


Counting the number of indicators without a tracker in each country
```{r, echo = FALSE}

ind_count <- glob_inds %>%
  filter(!is.na(code)) %>%
  group_by(entity, code) %>%
  summarise(got_ind = sum(!is.na(latest_data_year)), missing_ind = 244 - got_ind) %>% 
  ungroup() %>% 
  #arrange(-got_ind) %>% 
  mutate(rank = rank(missing_ind))

```

```{r, echo = FALSE}

world <- ne_countries(scale = "small", returnclass = "sf")

world_df <-
  merge(world,
        ind_count,
        by.x = "adm0_a3",
        by.y = "code",
        all = TRUE)

world_dis <- world_df  %>%
  group_by(adm0_a3) %>%
  filter(got_ind > 0)

ggplot(data = world_dis) +
  geom_sf(aes(fill = got_ind )) +
  scale_fill_viridis_c(option = "plasma") +
  theme_bw()

##make this into a leaflet 

```

```{r, echo = FALSE}
ggplot(data = world_dis) +
  geom_sf(aes(fill = rank, col = rank)) +
  scale_fill_viridis_c(option = "plasma") +
  scale_color_viridis_c(option = "plasma") +
  theme_bw()


```

```{r, echo = FALSE}
kable(ind_count %>% 
  dplyr::select(entity, got_ind) %>% 
  arrange(got_ind) %>% 
  head(., 20))
```



```{r, echo = FALSE, eval = FALSE}
inds %>% 
  group_by(indicator_tier, pillar) %>% 
#  summarise(count = n(),no_track_count = sum(sdg_tracker_indicator_available == "No"), prop_no = no_track_count/count)
  filter(indicator_tier == 3) %>% 
  select(official_indicator, sdgt_date_of_most_recent_data) %>% 
  distinct()

kable(inds$sdgt_data_publisher)

```
